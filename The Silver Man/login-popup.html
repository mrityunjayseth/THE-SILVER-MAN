<!DOCTYPE html>
<html>
<head>
  <title>Login/Signup</title>
  <link rel="stylesheet" href="gold-accent.css">
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
    }
    .auth-container {
      max-width: 400px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(212, 175, 55, 0.15);
      border-top: 4px solid #d4af37;
    }
    .close-btn {
      position: absolute;
      right: 15px;
      top: 15px;
      font-size: 24px;
      cursor: pointer;
    }
    /* Rest of the auth styles from previous implementation */
    .auth-tabs { display: flex; margin-bottom: 20px; }
    .tab-btn { flex: 1; padding: 10px; background: #f1f1f1; border: none; cursor: pointer; }
    .tab-btn.active { background: #333; color: white; }
    .auth-tab { display: none; }
    .auth-tab.active { display: block; }
    .auth-form { display: flex; flex-direction: column; gap: 15px; }
    .auth-form input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
    .auth-form button { 
      padding: 12px; 
      background: #d4af37; 
      color: white; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .auth-form button:hover {
      background: #c19b2e;
      transform: translateY(-2px);
    }
    .auth-divider { text-align: center; margin: 15px 0; position: relative; }
    .auth-divider::before { content: ""; position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: #ddd; z-index: -1; }
    .auth-divider span { background: white; padding: 0 10px; }
    .google-auth { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 10px; 
      padding: 12px; 
      width: 100%; 
      background: white; 
      border: 1px solid #ddd; 
      border-radius: 6px; 
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .google-auth:hover {
      background: #f8f8f8;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <span class="close-btn" onclick="window.parent.postMessage('closePopup', '*')">Ã—</span>
  <div class="auth-container">
    <h2>Welcome</h2>
    <div class="auth-tabs">
      <button class="tab-btn active" onclick="openTab('login')">Login</button>
      <button class="tab-btn" onclick="openTab('signup')">Sign Up</button>
    </div>
    
    <div id="login" class="auth-tab active">
      <form class="auth-form" id="loginForm">
        <input type="email" id="loginEmail" placeholder="Email" required>
        <input type="password" id="loginPassword" placeholder="Password" required>
        <button type="submit">Login</button>
      </form>
      <script>
        document.getElementById('loginForm').addEventListener('submit', function(e) {
          e.preventDefault();
          const email = document.getElementById('loginEmail').value;
          const user = {
            email: email,
            username: email.split('@')[0],
            loginTime: new Date().toISOString(),
            lastActive: new Date().toISOString(),
            wishlist: JSON.parse(localStorage.getItem(`wishlist_${email}`)) || [],
            cart: JSON.parse(localStorage.getItem(`cart_${email}`)) || [],
            orderHistory: JSON.parse(localStorage.getItem(`orders_${email}`)) || []
          };
          
          // Get or create customer profile
          let customers = JSON.parse(localStorage.getItem('customers')) || [];
          let customer = customers.find(c => c.email === email);
          
          if (customer) {
            // Update existing customer
            customer.lastActive = user.lastActive;
            customer.loginCount = (customer.loginCount || 0) + 1;
            // Merge existing data
            user.wishlist = [...new Set([...user.wishlist, ...(customer.wishlist || [])])];
            user.cart = [...new Set([...user.cart, ...(customer.cart || [])])];
            user.orderHistory = [...new Set([...user.orderHistory, ...(customer.orderHistory || [])])];
          } else {
            // New customer
            user.firstLogin = user.loginTime;
            user.loginCount = 1;
            customers.push(user);
          }
          
          // Save all data
          localStorage.setItem('user', JSON.stringify(user));
          localStorage.setItem('customers', JSON.stringify(customers));
          localStorage.setItem(`wishlist_${email}`, JSON.stringify(user.wishlist));
          localStorage.setItem(`cart_${email}`, JSON.stringify(user.cart));
          localStorage.setItem(`orders_${email}`, JSON.stringify(user.orderHistory));
          
          // Update UI
          window.parent.postMessage({
            type: 'authSuccess',
            user: user
          }, '*');
          window.parent.postMessage('closePopup', '*');
          
          // Refresh user-dependent components
          window.parent.postMessage({
            type: 'refreshData',
            data: {
              wishlist: user.wishlist,
              cart: user.cart,
              orders: user.orderHistory
            }
          }, '*');
        });
      </script>
      <div class="auth-divider"><span>or</span></div>
      <button class="google-auth" onclick="authWithGoogle()">
        <img src="https://img.icons8.com/color/16/000000/google-logo.png" alt="Google">
        Continue with Google
      </button>
    </div>
    
    <div id="signup" class="auth-tab">
      <form class="auth-form" id="signupForm">
        <input type="text" id="signupName" placeholder="Full Name" required>
        <input type="email" id="signupEmail" placeholder="Email" required>
        <input type="password" id="signupPassword" placeholder="Password" required>
        <button type="submit">Create Account</button>
      </form>
      <script>
        document.getElementById('signupForm').addEventListener('submit', function(e) {
          e.preventDefault();
          const email = document.getElementById('signupEmail').value;
          const user = {
            name: document.getElementById('signupName').value,
            email: email,
            username: email.split('@')[0],
            signupTime: new Date().toISOString(),
            lastActive: new Date().toISOString(),
            firstLogin: new Date().toISOString(),
            loginCount: 1,
            wishlist: [],
            cart: [],
            orderHistory: []
          };
          
          // Save all data
          localStorage.setItem('user', JSON.stringify(user));
          
          let customers = JSON.parse(localStorage.getItem('customers')) || [];
          customers.push(user);
          localStorage.setItem('customers', JSON.stringify(customers));
          
          // Initialize storage for user features
          localStorage.setItem(`wishlist_${email}`, JSON.stringify(user.wishlist));
          localStorage.setItem(`cart_${email}`, JSON.stringify(user.cart));
          localStorage.setItem(`orders_${email}`, JSON.stringify(user.orderHistory));
          
          window.parent.postMessage({
            type: 'authSuccess',
            user: user
          }, '*');
          window.parent.postMessage('closePopup', '*');
        });
      </script>
      <div class="auth-divider"><span>or</span></div>
      <button class="google-auth" onclick="authWithGoogle()">
        <img src="https://img.icons8.com/color/16/000000/google-logo.png" alt="Google">
        Continue with Google
      </button>
    </div>
  </div>

  <script>
    function openTab(tabName) {
      const tabs = document.querySelectorAll('.auth-tab');
      const btns = document.querySelectorAll('.tab-btn');
      
      tabs.forEach(tab => tab.classList.remove('active'));
      btns.forEach(btn => btn.classList.remove('active'));
      
      document.getElementById(tabName).classList.add('active');
      event.currentTarget.classList.add('active');
    }

    function authWithGoogle() {
      // Load Google API client
      const script = document.createElement('script');
      script.src = 'https://accounts.google.com/gsi/client';
      script.async = true;
      script.defer = true;
      document.body.appendChild(script);

      // Initialize Google client
      script.onload = function() {
        google.accounts.id.initialize({
          client_id: 'YOUR_GOOGLE_CLIENT_ID', // Replace with your actual client ID
          callback: handleGoogleAuth
        });
        google.accounts.id.prompt();
      };

      function handleGoogleAuth(response) {
        const user = parseGoogleResponse(response);
        
        // Save user data
        let customers = JSON.parse(localStorage.getItem('customers')) || [];
        let existingUser = customers.find(c => c.email === user.email);
        
        if (!existingUser) {
          // New Google user
          user.signupTime = new Date().toISOString();
          user.loginCount = 1;
          user.wishlist = [];
          user.cart = [];
          user.orderHistory = [];
          customers.push(user);
        } else {
          // Existing user
          existingUser.lastActive = new Date().toISOString();
          existingUser.loginCount = (existingUser.loginCount || 0) + 1;
          user = {...existingUser, ...user};
        }

        localStorage.setItem('user', JSON.stringify(user));
        localStorage.setItem('customers', JSON.stringify(customers));
        
        // Update UI
        window.parent.postMessage({
          type: 'authSuccess',
          user: user
        }, '*');
        window.parent.postMessage('closePopup', '*');
      }

      function parseGoogleResponse(response) {
        const { credential } = response;
        const payload = JSON.parse(atob(credential.split('.')[1]));
        
        return {
          email: payload.email,
          name: payload.name,
          username: payload.email.split('@')[0],
          picture: payload.picture,
          googleId: payload.sub,
          lastActive: new Date().toISOString(),
          isGoogleAuth: true
        };
      }
    }
  </script>
</body>
</html>
